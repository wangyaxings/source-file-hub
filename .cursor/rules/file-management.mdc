---
description: 文件管理和版本控制指南
---

# 文件管理和版本控制

## 支持的文件类型
- **Roadmap**: `.tsv` 文件
- **Recommendation**: `.xlsx` 文件
- **包文件**: `.zip` 文件（assets/others）

## 文件存储结构
```
downloads/
├── roadmaps/
│   ├── v20250101T120000Z/
│   │   ├── roadmap_v20250101T120000Z.tsv
│   │   └── manifest.json
│   └── roadmap.tsv (最新版本链接)
├── recommendations/
│   ├── v20250101T120000Z/
│   │   ├── recommendation_v20250101T120000Z.xlsx
│   │   └── manifest.json
│   └── recommendation.xlsx (最新版本链接)
└── packages/
    └── {tenantToken}/
        ├── assets/
        └── others/
```

## 版本控制机制
- **版本ID格式**: `v{YYYYMMDDTHHMMSSZ}`
- **文件命名**: `{type}_{versionID}.{ext}`
- **清单文件**: 每个版本包含 `manifest.json`
- **最新链接**: 硬链接指向最新版本

## 上传流程
1. 验证文件类型和扩展名
2. 生成版本ID和时间戳
3. 创建版本目录
4. 保存文件到版本目录
5. 创建最新版本链接
6. 生成SHA256校验和
7. 保存到数据库
8. 写入版本清单

## 数据库记录
使用 [internal/database/database.go](mdc:internal/database/database.go) 中的 `FileRecord` 结构：
- 文件元数据
- 版本信息
- 上传者信息
- 校验和
- 状态（active/deleted/purged）

## 回收站机制
- **软删除**: 文件标记为删除状态
- **恢复**: 从回收站恢复文件
- **永久删除**: 物理删除文件和记录
- **批量清理**: 清空整个回收站

## 权限控制
- 基于用户角色控制上传/下载权限
- 管理员可以管理所有文件
- 普通用户只能管理自己的文件
- 支持文件类型限制

## 安全特性
- 路径遍历保护
- 文件类型验证
- 大小限制（128MB）
- 病毒扫描（可扩展）
- 访问日志记录